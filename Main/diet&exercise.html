<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Recommendations | Blood Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #2e7aad;
            --secondary-color: #3b637d;
            --light-bg: #f8f9fa;
            --border-color: #e0e7ee;
            --warning-color: #e67e22;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--light-bg);
        }

        .container {
            width: 100%;
            min-width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        header {
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            text-align: center;
        }

        nav {
            background-color: #87bdd8;
            padding: 1rem;
            text-align: center;
        }

        nav a {
            color: white;
            margin: 0 1rem;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background 0.3s;
            font-family: Arial, sans-serif;
        }

        nav a:hover {
            background-color: #1f5f91;
        }

        .tabs {
            display: flex;
            background-color: #f0f7ff;
            border-bottom: 1px solid var(--border-color);
            margin: 0 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 3px solid transparent;
            font-size: 18px;
        }

        .tab:hover {
            background-color: rgba(96, 165, 184, 0.1);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
            margin: 0 20px 20px 20px;
        }

        .tab-content.active {
            display: block;
        }

        .food-item:hover {
            background-color: #f0f7ff;
            transform: scale(1.02);
            transition: background-color 0.3s, transform 0.2s;
        }

        .section-title {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .parameter-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        .parameter-card h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .parameter-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .status-normal {
            background-color: #e1f5e5;
            color: #2ecc71;
        }

        .status-low {
            background-color: #fdebd0;
            color: #e67e22;
        }

        .status-high {
            background-color: #f5d9d7;
            color: #e74c3c;
        }

        .parameter-card.anemia {
            border-left-color: #e67e22;
        }

        .parameter-card.diabetes {
            border-left-color: #e74c3c;
        }

        .parameter-card.inflammation {
            border-left-color: #9b59b6;
        }

        .food-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: space-between;
            /* Distributes items evenly */
            width: 100%;
            /* Ensures the container uses full width */
        }

        .food-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            min-height: 120px;
            position: relative;
            flex-basis: 24%;
            /* Approx. 25% minus gap adjustment */
            max-width: 24%;
            /* Ensures consistent width */
        }





        .food-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .food-icon {
            font-size: 30px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f7ff;
            border-radius: 50%;
        }

        .Login {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .user-info-link {
            text-decoration: none;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .username {
            font-size: 16px;
            font-weight: bold;
        }

        .exercise-item:hover {
            background-color: #f0f7ff;
            transform: scale(1.02);
            transition: background-color 0.3s, transform 0.2s;
        }

        .food-title {
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 20px;
            color: var(--secondary-color);
        }

        .food-title,
        .exercise-title {
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 20px;
            color: var(--secondary-color);
            word-break: break-word;
            /* Allows long words to wrap */
            max-width: calc(100% - 60px);
            /* Reserves space for the 40px button + 20px margin */
        }

        .food-title:hover,
        .exercise-title:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .food-description {
            font-size: 18px;
            color: #1b1b1b;
        }

        .guidelines {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .exercise-recommendations {
            margin-top: 30px;
        }

        .exercise-item {
            display: flex;
            align-items: flex-start;
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            /* Increased from 20px */
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .exercise-item-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            height: 40px;
            background-color: #f0f7ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .exercise-item-content {
            flex: 1;
        }

        .exercise-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .exercise-description {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .exercise-steps {
            font-size: 16px;
            margin-bottom: 5px;
            padding-left: 20px;
        }

        .exercise-duration {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .meal-plan-day {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .meal-plan-day h4 {
            margin-bottom: 15px;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .meal-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }

        .meal-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .meal-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .meal-description {
            font-size: 16px;
            color: #555;
        }

        .ai-recommendation {
            background-color: #f0f7ff;
            border-left: 5px solid #62a6b8;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #62a6b8;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .meal-nutrition {
            font-size: 12px;
            color: #3b637d;
            font-style: italic;
            margin-top: 4px;
        }

        .delete-icon {
            position: absolute;
            top: 15px;
            /* Increased from 10px */
            right: 15px;
            /* Increased from 10px */
            font-size: 24px;
            color: var(--danger-color);
            background-color: #f5d9d7;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 1px solid var(--danger-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }

        .delete-icon:hover {
            background-color: #e74c3c;
            /* --danger-color */
            color: white;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
            }

            .tab-content {
                display: block !important;
            }
        }

        @media (max-width: 768px) {
            .food-list {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 20px;
            }

            header p {
                font-size: 12px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 16px;
            }

            .tab-content {
                padding: 15px;
                margin: 0 10px 10px 10px;
            }

            .tabs {
                margin: 0 10px;
            }

            .container {
                padding: 0;
            }

            .food-item,
            .exercise-item {
                padding: 20px;
                /* Reduce on small screens */
            }

            .delete-icon {
                top: 10px;
                right: 10px;
            }
        }

        #logoutBtn:hover {
            background-color: #dc3545;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="Login">
                <a href="profile.html" class="user-info-link">
                    <div class="user-info">
                        <img src="" alt="Profile Picture" class="profile-pic" id="profilePic">
                        <span class="username" id="username"></span>
                    </div>
                </a>
            </div>
            <h1>Diet & Exercise Recommendations</h1>
            <p>Personalized advice based on your blood test results.</p>
        </header>

        <nav>
            <a href="home.html">Home</a>
            <a href="upld.html">Upload Reports</a>
            <a href="progress.html">Track Progress</a>
            <a href="storage.html" aria-label="Storage">Storage</a>
            <a href="#" id="logoutBtn" aria-label="Logout">Logout</a>
        </nav>

        <div class="tabs">
            <div class="tab active" data-tab="overview">Overview</div>
            <div class="tab" data-tab="diet">Diet</div>
            <div class="tab" data-tab="exercise">Exercise</div>
        </div>

        <div id="overview" class="tab-content active">
            <div id="patientSummary"></div>
        </div>

        <div id="diet" class="tab-content">
            <h3 class="section-title">Dietary Recommendations</h3>
            <div id="dietLoadingIndicator">
                <p>Loading dietary recommendations... <span class="spinner"></span></p>
            </div>
            <div id="dietContent" style="display: none;">
                <div id="dietSummary"></div>
                <h4 class="section-title">Foods to Include</h4>
                <div id="recommendedFoods" class="food-list"></div>
                <h4 class="section-title">Foods to Limit</h4>
                <div id="limitFoods" class="food-list"></div>
                <div class="guidelines">
                    <h4>General Nutrition Guidelines</h4>
                    <ul id="nutritionGuidelines"></ul>
                </div>
            </div>
        </div>

        <div id="exercise" class="tab-content">
            <h3 class="section-title">Exercise Recommendations</h3>
            <div id="exerciseLoadingIndicator">
                <p>Loading exercise recommendations... <span class="spinner"></span></p>
            </div>
            <div id="exerciseContent" style="display: none;">
                <div id="exerciseSummary"></div>
                <div id="exerciseRecommendations" class="exercise-recommendations"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { checkAuthAndRedirect, displayUserInfo, handleLogout } from './scripts/auth.js';
        import { db } from "./scripts/firebase-storage-config.js";
        import { getCurrentUserId, isAuthenticated } from "./scripts/user-data-service.js";
        import { supabase } from "./scripts/config.js";
        import {
            collection,
            query,
            orderBy,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        function generateProfileHash(profile) {
            const relevantFields = {
                birthdate: profile.birthdate || '',
                gender: profile.gender || '',
                weight: profile.weight || '',
                height: profile.height || '',
                medicalInfo: profile.medicalInfo || '',
                country: profile.country || '',
                customCountry: profile.customCountry || ''
            };
            const str = JSON.stringify(relevantFields);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        async function initializeApp() {
            const isLoggedIn = await checkAuthAndRedirect();
            if (!isLoggedIn) return;

            const userProfile = await fetchUserProfile();
            if (!userProfile) {
                console.warn("User profile not loaded; proceeding with default recommendations.");
            } else {
                console.log("User profile loaded:", userProfile);
            }

            initializeUI();

            document.getElementById('patientSummary').innerHTML = `
                <div class="parameter-card">
                    <h3>Loading Data</h3>
                    <p>Fetching your latest blood test data... <span class="spinner"></span></p>
                </div>
            `;

            const latestReport = await getLatestBloodReport();
            if (latestReport) {
                generateRecommendations(latestReport, userProfile);
            } else {
                showNoDataMessage();
            }
        }

        async function fetchUserProfile() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) throw error;
                if (!user) {
                    console.error("No authenticated user found");
                    window.location.href = 'index.html';
                    return null;
                }
                return user.user_metadata || {};
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        }

        function initializeUI() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    console.log(`Tab clicked: ${tabId}`);
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const content = document.getElementById(tabId);
                    if (content) {
                        content.classList.add('active');
                    } else {
                        console.error(`Tab content not found: ${tabId}`);
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function getLatestBloodReport() {
            try {
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.error("No user logged in");
                    return null;
                }

                const reportsRef = collection(db, "users", userId, "bloodReports");
                const q = query(reportsRef, orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No reports found for user");
                    return null;
                }

                const reports = [];
                querySnapshot.forEach((doc) => {
                    const reportData = doc.data();
                    reports.push({
                        id: doc.id,
                        ...reportData,
                        date: reportData.date?.toDate().toISOString() || new Date().toISOString()
                    });
                });

                const expectedParams = ['Hemoglobin', 'Glucose', 'CRP', 'RBC', 'Cholesterol', 'LDL', 'HDL', 'PCV'];
                return reports.find(report =>
                    report.date && report.values && report.analysisHTML &&
                    expectedParams.some(param => report.values[param] != null)
                ) || null;
            } catch (error) {
                console.error("Error fetching latest report from Firestore:", error);
                return null;
            }
        }

        function parseAnalysisHTML(analysisHTML) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(analysisHTML, 'text/html');
            const testResults = [];
            const patientInfo = {};

            const patientInfoDiv = doc.querySelector('div.patient-info');
            if (patientInfoDiv) {
                patientInfoDiv.querySelectorAll('.patient-info-item').forEach(item => {
                    const [key, value] = item.textContent.trim().split(':').map(s => s.trim());
                    if (key && value) patientInfo[key.toLowerCase()] = value;
                });
            }

            const table = doc.querySelector('table.results-table');
            if (table) {
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim().toLowerCase());
                const rows = table.querySelectorAll('tr');
                const testNameIndex = headers.indexOf('test name/parameter');
                const resultIndex = headers.indexOf('result');
                const unitIndex = headers.indexOf('unit');
                const rangeIndex = headers.indexOf('reference range');
                const statusIndex = headers.indexOf('status');

                if (testNameIndex !== -1 && resultIndex !== -1 && statusIndex !== -1) {
                    for (let i = 1; i < rows.length; i++) {
                        const cells = rows[i].querySelectorAll('td');
                        if (cells.length < headers.length) continue;

                        const testName = cells[testNameIndex].textContent.trim();
                        const result = parseFloat(cells[resultIndex].textContent.trim());
                        const unit = unitIndex !== -1 ? cells[unitIndex].textContent.trim() : 'N/A';
                        const range = rangeIndex !== -1 ? cells[rangeIndex].textContent.trim() : 'N/A';
                        const status = cells[statusIndex].textContent.trim();

                        if (!isNaN(result)) {
                            testResults.push({ testName, result, unit, referenceRange: range, status });
                        }
                    }
                }
            }
            return { testResults, patientInfo };
        }

        function showNoDataMessage() {
            document.getElementById('patientSummary').innerHTML = `
                <div class="parameter-card">
                    <h3>No Data Available</h3>
                    <p>No blood test data was found. Please upload a blood test report to receive personalized recommendations.</p>
                    <button id="uploadButton" style="background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-top: 15px;">Upload Blood Test</button>
                </div>
            `;
            document.getElementById('uploadButton').addEventListener('click', () => window.location.href = 'upld.html');
        }

        async function getGeminiRecommendations(bloodData, userProfile) {
            if (!bloodData || !bloodData.analysisHTML) return null;

            const { testResults, patientInfo } = parseAnalysisHTML(bloodData.analysisHTML);
            const testDate = new Date(bloodData.date).toLocaleDateString();

            const testResultsText = testResults.map(result =>
                `- ${result.testName}: ${result.result} ${result.unit} (${result.status}, Reference: ${result.referenceRange})`
            ).join('\n') || 'No test results available.';
            const patientInfoText = Object.entries(patientInfo).map(([key, value]) => `${key}: ${value}`).join(', ');

            let age = null;
            if (userProfile?.birthdate) {
                const birthDate = new Date(userProfile.birthdate);
                age = new Date().getFullYear() - birthDate.getFullYear();
            }

            const apiKey = 'AIzaSyCaBpjdVtlzriQUljPhAmxRem49DNBPFGU';
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const promptText = `Analyze the following blood test report and generate highly personalized diet and exercise recommendations based on test results, patient data, and this user profile:
- Age: ${age || 'Not provided'}
- Gender: ${userProfile?.gender || 'Not provided'}
- Weight: ${userProfile?.weight ? `${userProfile.weight} kg` : 'Not provided'}
- Height: ${userProfile?.height ? `${userProfile.height} cm` : 'Not provided'}
- Medical History: ${userProfile?.medicalInfo || 'Not provided'}
- Country: ${userProfile?.country || 'Not provided'}

### Guidelines:

Only generate specific, personalized recommendations. Avoid generic advice or fallback suggestions.

**Diet**:
- Recommend â‰¥4 foods to include. Each must be tied to specific test results and user profile.
- Recommend foods to limit with reasons based on the report and profile.
- Tailor nutrition guidelines to the user's age, gender, weight, height, medical history, and country.
- Each food must include a relevant emoji icon. Icons **must match** the food (e.g., no broccoli emoji for almonds).

**Exercise**:
- Recommend exactly 5 **distinct** exercises.
- Each must be tailored to relevant test results and user profile (e.g., low hemoglobin â†’ low-impact routines).
- Avoid generic exercises unless **justified** with a specific variation.
- Each should have:
  - Name (e.g., "Goblet Squat")
  - Reason (explicitly tied to the test values and profile)
  - 3+ steps
  - Duration (e.g., "20 mins")
  - A matching emoji icon (e.g., no yoga icon for a cardio routine)

**Test Results**:
${testResultsText}

**Test Date**:
${testDate}

**Patient Information**:
${patientInfoText}

### Output Format:
Respond with **only a valid JSON object** using this structure (no markdown/code formatting):

{
  "diet": {
    "summary": "...",
    "recommendedFoods": [
      { "name": "...", "description": "...", "icon": "ðŸŽ" }
    ],
    "foodsToLimit": [
      { "name": "...", "description": "...", "icon": "ðŸ©" }
    ],
    "nutritionGuidelines": [
      "..."
    ]
  },
  "exercise": {
    "summary": "...",
    "exercises": [
      {
        "name": "...",
        "description": "...",
        "steps": ["...", "..."],
        "duration": "...",
        "icon": "ðŸƒ"
      }
    ]
  }
}
`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }],
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }
                        ]
                    })
                });

                if (!response.ok) throw new Error(`API request failed: ${response.status}`);

                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    let generatedText = data.candidates[0].content.parts[0].text.trim();
                    generatedText = generatedText.replace(/^```json\n|\n```$/g, '');
                    const jsonMatch = generatedText.match(/{[\s\S]*}/);
                    if (jsonMatch) generatedText = jsonMatch[0];

                    const recommendations = JSON.parse(generatedText);
                    return {
                        diet: recommendations.diet || { summary: '', recommendedFoods: [], foodsToLimit: [], nutritionGuidelines: [] },
                        exercise: recommendations.exercise || { summary: '', exercises: [] }
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching AI recommendations:', error);
                return null;
            }
        }

        async function getSingleGeminiRecommendation(type, bloodData, userProfile, existingItems) {
            if (!bloodData || !bloodData.analysisHTML) return null;

            const { testResults, patientInfo } = parseAnalysisHTML(bloodData.analysisHTML);
            const testDate = new Date(bloodData.date).toLocaleDateString();
            const testResultsText = testResults.map(result =>
                `- ${result.testName}: ${result.result} ${result.unit} (${result.status}, Reference: ${result.referenceRange})`
            ).join('\n') || 'No test results available.';
            const patientInfoText = Object.entries(patientInfo).map(([key, value]) => `${key}: ${value}`).join(', ');

            let age = null;
            if (userProfile?.birthdate) {
                const birthDate = new Date(userProfile.birthdate);
                age = new Date().getFullYear() - birthDate.getFullYear();
            }

            const apiKey = 'AIzaSyCaBpjdVtlzriQUljPhAmxRem49DNBPFGU';
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const existingItemsText = existingItems.length > 0
                ? `**Existing ${type === 'exercises' ? 'Exercises' : 'Foods'} (Do Not Recommend These)**:\n${existingItems.map(item => `- ${item.name}`).join('\n')}`
                : 'No existing items to exclude.';

            const promptText = `Generate a single ${type === 'exercises' ? 'exercise' : 'food'} recommendation to replace a removed item, tailored to the user's blood test results and profile:
- Type: ${type === 'recommendedFoods' ? 'food to include' : type === 'foodsToLimit' ? 'food to limit' : 'exercise'}
- Age: ${age || 'Not provided'}
- Gender: ${userProfile?.gender || 'Not provided'}
- Weight: ${userProfile?.weight ? `${userProfile.weight} kg` : 'Not provided'}
- Height: ${userProfile?.height ? `${userProfile.height} cm` : 'Not provided'}
- Medical History: ${userProfile?.medicalInfo || 'Not provided'}
- Country: ${userProfile?.country || 'Not provided'}

### Guidelines:
- Provide one specific recommendation tied to the test results and profile.
- **Do not recommend any item listed below** to avoid duplicates.
- For foods, include a matching emoji icon (e.g., apple â†’ ðŸŽ, not ðŸ¥¦).
- For exercises, include:
  - Name (e.g., "Goblet Squat")
  - Reason (tied to test values/profile)
  - 3+ steps
  - Duration (e.g., "20 mins")
  - Matching emoji icon
- Avoid generic suggestions.

${existingItemsText}

**Test Results**:
${testResultsText}

**Test Date**:
${testDate}

**Patient Information**:
${patientInfoText}

### Output Format:
Return a JSON object:
${type === 'exercises' ?
                    `{ "name": "...", "description": "...", "steps": ["...", "..."], "duration": "...", "icon": "ðŸƒ" }` :
                    `{ "name": "...", "description": "...", "icon": "ðŸŽ" }`
                }
`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }],
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }
                        ]
                    })
                });

                if (!response.ok) throw new Error(`API request failed: ${response.status}`);

                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    let generatedText = data.candidates[0].content.parts[0].text.trim();
                    generatedText = generatedText.replace(/^```json\n|\n```$/g, '');
                    const jsonMatch = generatedText.match(/{[\s\S]*}/);
                    if (jsonMatch) generatedText = jsonMatch[0];
                    return JSON.parse(generatedText);
                }
                return null;
            } catch (error) {
                console.error('Error fetching single recommendation:', error);
                return null;
            }
        }


        async function getOrGenerateRecommendations(bloodData, userProfile) {
            try {
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.error("No user ID available");
                    return null;
                }

                const profileHash = generateProfileHash(userProfile);
                const recommendationsRef = doc(db, "users", userId, "recommendations", bloodData.id);
                const recommendationsDoc = await getDoc(recommendationsRef);

                if (recommendationsDoc.exists()) {
                    const storedData = recommendationsDoc.data();
                    if (storedData.profileHash === profileHash) {
                        console.log("Using cached recommendations from Firebase");
                        return {
                            diet: storedData.diet,
                            exercise: storedData.exercise
                        };
                    } else {
                        console.log("Profile hash changed; regenerating recommendations");
                    }
                } else {
                    console.log("No cached recommendations found");
                }

                console.log("Generating new recommendations with Gemini");
                const aiRecommendations = await getGeminiRecommendations(bloodData, userProfile);

                if (aiRecommendations) {
                    await setDoc(recommendationsRef, {
                        bloodReportId: bloodData.id,
                        timestamp: new Date(),
                        profileHash,
                        diet: aiRecommendations.diet,
                        exercise: aiRecommendations.exercise
                    });
                    console.log("New recommendations saved to Firebase with profile hash");
                    return aiRecommendations;
                }
                return null;
            } catch (error) {
                console.error("Error with recommendations:", error);
                return await getGeminiRecommendations(bloodData, userProfile);
            }
        }

        async function deleteItem(type, index, bloodData, userProfile) {
            if (!confirm('Are you sure you want to remove this item?')) return null;

            try {
                const userId = await getCurrentUserId();
                const recommendationsRef = doc(db, "users", userId, "recommendations", bloodData.id);
                const recommendationsDoc = await getDoc(recommendationsRef);

                if (!recommendationsDoc.exists()) {
                    console.error("No recommendations found");
                    return null;
                }

                const data = recommendationsDoc.data();
                let updatedItems = [];
                let existingItems = [];

                if (type === 'recommendedFoods') {
                    updatedItems = [...data.diet.recommendedFoods];
                    existingItems = updatedItems.filter((_, i) => i !== index); // Exclude item being deleted
                    updatedItems.splice(index, 1);
                    data.diet.recommendedFoods = updatedItems;
                } else if (type === 'foodsToLimit') {
                    updatedItems = [...data.diet.foodsToLimit];
                    existingItems = updatedItems.filter((_, i) => i !== index);
                    updatedItems.splice(index, 1);
                    data.diet.foodsToLimit = updatedItems;
                } else if (type === 'exercises') {
                    updatedItems = [...data.exercise.exercises];
                    existingItems = updatedItems.filter((_, i) => i !== index);
                    updatedItems.splice(index, 1);
                    data.exercise.exercises = updatedItems;
                }

                const newItem = await getSingleGeminiRecommendation(type, bloodData, userProfile, existingItems);
                if (newItem) {
                    if (type === 'recommendedFoods') {
                        data.diet.recommendedFoods.push(newItem);
                    } else if (type === 'foodsToLimit') {
                        data.diet.foodsToLimit.push(newItem);
                    } else if (type === 'exercises') {
                        data.exercise.exercises.push(newItem);
                    }
                } else {
                    console.warn('No replacement item received from API');
                }

                await setDoc(recommendationsRef, data, { merge: true });
                return data;
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Failed to delete item. Please try again.');
                return null;
            }
        }

        async function generateRecommendations(bloodData, userProfile) {
            if (!bloodData || !bloodData.analysisHTML) {
                showNoDataMessage();
                return;
            }

            const { testResults, patientInfo } = parseAnalysisHTML(bloodData.analysisHTML);
            const date = new Date(bloodData.date).toLocaleDateString();
            const patientSummary = document.getElementById('patientSummary');

            patientSummary.innerHTML = `
                <h3 class="section-title">Health Profile</h3>
                <p>Recommendations based on your blood test from ${date}</p>
                <div id="loadingIndicator">
                    <p>Generating personalized AI recommendations... <span class="spinner"></span></p>
                </div>
                <div id="abnormalParameters"></div>
            `;

            const abnormalParamsContainer = document.getElementById('abnormalParameters');
            testResults.forEach(result => {
                const testName = result.testName.toLowerCase();
                const status = result.status.toLowerCase();
                let elem;

                if ((testName.includes('hemoglobin') || testName.includes('hb')) && status === 'low') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card anemia';
                    elem.innerHTML = `
                        <h3>Hemoglobin <span class="parameter-status status-low">${status}</span></h3>
                        <p>Your hemoglobin level of ${result.result} ${result.unit} is below the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('glucose') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card diabetes';
                    elem.innerHTML = `
                        <h3>Glucose <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your glucose level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('crp') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card inflammation';
                    elem.innerHTML = `
                        <h3>C-Reactive Protein <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your CRP level of ${result.result} ${result.unit} is elevated (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('rbc') && status === 'low') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card anemia';
                    elem.innerHTML = `
                        <h3>Red Blood Cell Count <span class="parameter-status status-low">${status}</span></h3>
                        <p>Your RBC count of ${result.result} ${result.unit} is below the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('cholesterol') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>Cholesterol <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your cholesterol level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('ldl') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>LDL Cholesterol <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your LDL level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('hdl') && status === 'low') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>HDL Cholesterol <span class="parameter-status status-low">${status}</span></h3>
                        <p>Your HDL level of ${result.result} ${result.unit} is below the normal range (${result.referenceRange}).</p>
                    `;
                } else if ((testName.includes('pcv') || testName.includes('hematocrit')) && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>PCV/Hematocrit <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your PCV level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                }

                if (elem) abnormalParamsContainer.appendChild(elem);
            });

            if (!abnormalParamsContainer.children.length) {
                abnormalParamsContainer.innerHTML = `
                    <div class="parameter-card">
                        <h3>Overall Health <span class="parameter-status status-normal">Normal</span></h3>
                        <p>Your blood test results appear to be within normal ranges.</p>
                    </div>
                `;
            }

            const aiRecommendations = await getOrGenerateRecommendations(bloodData, userProfile);
            document.getElementById('loadingIndicator').style.display = 'none';

            if (!aiRecommendations) {
                patientSummary.innerHTML += `
                    <div class="parameter-card">
                        <h3>Error</h3>
                        <p>Unable to generate recommendations at this time. Please try again later.</p>
                    </div>
                `;
                return;
            }

            generateDietRecommendations(aiRecommendations);
            generateExerciseRecommendations(aiRecommendations);
        }

        function generateDietRecommendations(aiRecommendations) {
            const dietLoadingIndicator = document.getElementById('dietLoadingIndicator');
            const dietContent = document.getElementById('dietContent');
            const dietSummary = document.getElementById('dietSummary');
            const recommendedFoods = document.getElementById('recommendedFoods');
            const limitFoods = document.getElementById('limitFoods');
            const nutritionGuidelines = document.getElementById('nutritionGuidelines');

            dietSummary.innerHTML = `
        <div class="ai-recommendation">
            <p>${aiRecommendations.diet.summary}</p>
        </div>
    `;

            recommendedFoods.innerHTML = '';
            aiRecommendations.diet.recommendedFoods.forEach((food, index) => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.dataset.id = `recommended-${index}`;
                foodItem.innerHTML = `
            <div class="food-icon">${food.icon || ''}</div>
            <div class="food-content">
                <a href="https://www.google.com/search?q=${encodeURIComponent(food.name)}" target="_blank" class="food-title">${food.name}</a>
                <div class="food-description">${food.description}</div>
            </div>
            <i class="fas fa-times delete-icon" title="Remove Item"></i>
        `;
                recommendedFoods.appendChild(foodItem);
            });

            limitFoods.innerHTML = '';
            aiRecommendations.diet.foodsToLimit.forEach((food, index) => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.dataset.id = `limit-${index}`;
                foodItem.innerHTML = `
            <div class="food-icon">${food.icon || ''}</div>
            <div class="food-content">
                <a href="https://www.google.com/search?q=${encodeURIComponent(food.name)}" target="_blank" class="food-title">${food.name}</a>
                <div class="food-description">${food.description}</div>
            </div>
            <i class="fas fa-times delete-icon" title="Remove Item"></i>
        `;
                limitFoods.appendChild(foodItem);
            });

            nutritionGuidelines.innerHTML = '';
            aiRecommendations.diet.nutritionGuidelines.forEach(guideline => {
                const li = document.createElement('li');
                li.textContent = guideline;
                nutritionGuidelines.appendChild(li);
            });

            document.querySelectorAll('#recommendedFoods .delete-icon').forEach((icon, idx) => {
                icon.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const itemElement = e.target.closest('.food-item');
                    itemElement.style.opacity = '0.5';
                    const latestReport = await getLatestBloodReport();
                    const userProfile = await fetchUserProfile();
                    const newRecommendations = await deleteItem('recommendedFoods', idx, latestReport, userProfile);
                    if (newRecommendations) {
                        generateDietRecommendations(newRecommendations);
                    }
                    itemElement.style.opacity = '1';
                });
            });

            document.querySelectorAll('#limitFoods .delete-icon').forEach((icon, idx) => {
                icon.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const itemElement = e.target.closest('.food-item');
                    itemElement.style.opacity = '0.5';
                    const latestReport = await getLatestBloodReport();
                    const userProfile = await fetchUserProfile();
                    const newRecommendations = await deleteItem('foodsToLimit', idx, latestReport, userProfile);
                    if (newRecommendations) {
                        generateDietRecommendations(newRecommendations);
                    }
                    itemElement.style.opacity = '1';
                });
            });

            dietLoadingIndicator.style.display = 'none';
            dietContent.style.display = 'block';
        }



        function generateExerciseRecommendations(aiRecommendations) {
            const exerciseLoadingIndicator = document.getElementById('exerciseLoadingIndicator');
            const exerciseContent = document.getElementById('exerciseContent');
            const exerciseSummary = document.getElementById('exerciseSummary');
            const exerciseRecommendations = document.getElementById('exerciseRecommendations');

            exerciseSummary.innerHTML = `
        <div class="ai-recommendation">
            <p>${aiRecommendations.exercise.summary}</p>
        </div>
    `;

            exerciseRecommendations.innerHTML = '';
            aiRecommendations.exercise.exercises.forEach((exercise, index) => {
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                exerciseItem.dataset.id = `exercise-${index}`;
                exerciseItem.innerHTML = `
            <div class="exercise-item-icon">${exercise.icon || ''}</div>
            <div class="exercise-item-content">
                <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(exercise.name + ' exercise')}" target="_blank" class="exercise-title">${exercise.name}</a>
                <div class="exercise-description">${exercise.description}</div>
                <ol class="exercise-steps">
                    ${exercise.steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
                <div class="exercise-duration">Duration: ${exercise.duration}</div>
            </div>
            <i class="fas fa-times delete-icon" title="Remove Item"></i>
        `;
                exerciseRecommendations.appendChild(exerciseItem);
            });

            document.querySelectorAll('#exerciseRecommendations .delete-icon').forEach((icon, idx) => {
                icon.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const itemElement = e.target.closest('.exercise-item');
                    itemElement.style.opacity = '0.5';
                    const latestReport = await getLatestBloodReport();
                    const userProfile = await fetchUserProfile();
                    const newRecommendations = await deleteItem('exercises', idx, latestReport, userProfile);
                    if (newRecommendations) {
                        generateExerciseRecommendations(newRecommendations);
                    }
                    itemElement.style.opacity = '1';
                });
            });

            exerciseLoadingIndicator.style.display = 'none';
            exerciseContent.style.display = 'block';
        }

    </script>
</body>

</html>