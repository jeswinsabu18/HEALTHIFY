<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Recommendations | Blood Analysis</title>
    <style>
        :root {
            --primary-color: #62a6b8;
            --secondary-color: #3b637d;
            --light-bg: #f5f9fc;
            --border-color: #e0e7ee;
            --warning-color: #e67e22;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--light-bg);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-title p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .header-actions button:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            background-color: #f0f7ff;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background-color: rgba(96, 165, 184, 0.1);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .parameter-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        .parameter-card h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .parameter-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .status-normal {
            background-color: #e1f5e5;
            color: #2ecc71;
        }

        .status-low {
            background-color: #fdebd0;
            color: #e67e22;
        }

        .status-high {
            background-color: #f5d9d7;
            color: #e74c3c;
        }

        .parameter-card.anemia {
            border-left-color: #e67e22;
        }

        .parameter-card.diabetes {
            border-left-color: #e74c3c;
        }

        .parameter-card.inflammation {
            border-left-color: #9b59b6;
        }

        .warning-card {
            background-color: #fff3f3;
            border-left: 4px solid var(--danger-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-card h3 {
            color: var(--danger-color);
            margin-bottom: 10px;
        }

        .food-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .food-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            border-left: 3px solid var(--primary-color);
        }

        .food-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .food-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .food-description {
            font-size: 13px;
            color: #666;
        }

        .guidelines {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .exercise-recommendations {
            margin-top: 30px;
        }

        .exercise-item {
            display: flex;
            align-items: flex-start;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .exercise-item-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            height: 40px;
            background-color: #f0f7ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .exercise-item-content {
            flex: 1;
        }

        .exercise-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .exercise-description {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .exercise-steps {
            margin-top: 10px;
            padding-left: 20px;
        }

        .exercise-steps li {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        .exercise-duration {
            font-size: 12px;
            color: var(--secondary-color);
            margin-top: 5px;
        }

        .meal-plan-day {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .meal-plan-day h4 {
            margin-bottom: 15px;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .meal-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }

        .meal-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .meal-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .meal-description {
            font-size: 14px;
            color: #555;
        }

        .ai-recommendation {
            background-color: #f0f7ff;
            border-left: 5px solid #62a6b8;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #62a6b8;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .meal-nutrition {
            font-size: 12px;
            color: #3b637d;
            font-style: italic;
            margin-top: 4px;
        }

        .badge-ai {
            display: inline-block;
            background-color: #62a6b8;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            vertical-align: middle;
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
            }

            .header-actions,
            .tabs {
                display: none;
            }

            .tab-content {
                display: block !important;
            }
        }

        @media (max-width: 768px) {
            .food-list {
                grid-template-columns: 1fr;
            }

            .header-title h1 {
                font-size: 20px;
            }

            .header-actions button {
                padding: 6px 12px;
                font-size: 12px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }

            .tab-content {
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-title">
                <h1>Health Recommendations</h1>
                <p>Based on your blood test analysis</p>
            </div>
            <div class="header-actions">
                <button id="goBackButton">Go Back</button>
                <button id="printButton">Print Report</button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="overview">Overview</div>
            <div class="tab" data-tab="diet">Diet</div>
            <div class="tab" data-tab="exercise">Exercise</div>
            <div class="tab" data-tab="mealplan">Meal Plan</div>
        </div>

        <div id="overview" class="tab-content active">
            <div id="patientSummary">
                <!-- Summary content will be populated here -->
            </div>
        </div>

        <div id="diet" class="tab-content">
            <h3 class="section-title">Dietary Recommendations</h3>
            <div id="dietLoadingIndicator">
                <p>Loading dietary recommendations... <span class="spinner"></span></p>
            </div>
            <div id="dietContent" style="display: none;">
                <div id="dietSummary">
                    <!-- Diet summary will be populated here -->
                </div>
                <h4 class="section-title">Foods to Include</h4>
                <div id="recommendedFoods" class="food-list">
                    <!-- Recommended foods will be populated here -->
                </div>
                <h4 class="section-title">Foods to Limit</h4>
                <div id="limitFoods" class="food-list">
                    <!-- Foods to limit will be populated here -->
                </div>
                <div class="guidelines">
                    <h4>General Nutrition Guidelines</h4>
                    <ul id="nutritionGuidelines">
                        <!-- Guidelines will be populated here -->
                    </ul>
                </div>
            </div>
        </div>

        <div id="exercise" class="tab-content">
            <h3 class="section-title">Exercise Recommendations</h3>
            <div id="exerciseSummary">
                <!-- Exercise summary will be populated here -->
            </div>
            <div id="exerciseRecommendations" class="exercise-recommendations">
                <!-- Exercise items will be populated here -->
            </div>
        </div>

        <div id="mealplan" class="tab-content">
            <h3 class="section-title">Personalized Kerala-Style Meal Plan</h3>
            <div id="mealPlanContainer">
                <!-- Meal plan will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Function to get the latest blood report from local storage
        function getLatestBloodReport() {
            const reportsString = localStorage.getItem('bloodReports');
            console.log('Raw bloodReports from localStorage:', reportsString);

            if (!reportsString) {
                console.log('No bloodReports found in localStorage');
                return null;
            }

            let reports;
            try {
                reports = JSON.parse(reportsString);
                console.log('Parsed bloodReports:', reports);
            } catch (parseError) {
                console.error('Failed to parse bloodReports from localStorage:', parseError);
                return null;
            }

            if (!Array.isArray(reports) || reports.length === 0) {
                console.log('bloodReports is empty or not an array:', reports);
                return null;
            }

            // Fixed sorting logic
            reports.sort((a, b) => new Date(b.date) - new Date(a.date));
            console.log('Sorted bloodReports (newest first):', reports);

            const expectedParams = ['Hemoglobin', 'Glucose', 'CRP', 'RBC', 'Cholesterol', 'LDL', 'HDL', 'PCV'];
            let latestValidReport = null;

            for (const report of reports) {
                if (!report.date || !report.values || !report.analysisHTML) {
                    console.log('Report is invalid (missing date, values, or analysisHTML):', report);
                    continue;
                }

                const hasExpectedParam = expectedParams.some(param => param in report.values && report.values[param] != null);
                if (hasExpectedParam) {
                    latestValidReport = report;
                    break;
                } else {
                    console.log('Report lacks expected parameters:', report);
                }
            }

            if (!latestValidReport) {
                console.log('No valid report found with expected parameters');
                return null;
            }

            console.log('Selected latest valid report:', latestValidReport);
            return latestValidReport;
        }

        // Function to parse analysis HTML
        function parseAnalysisHTML(analysisHTML) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(analysisHTML, 'text/html');
            const testResults = [];

            const table = doc.querySelector('table.results-table');
            if (!table) {
                console.warn('No results table found in analysisHTML');
                return { testResults, patientInfo: {} };
            }

            const patientInfoDiv = doc.querySelector('div.patient-info');
            const patientInfo = {};
            if (patientInfoDiv) {
                const items = patientInfoDiv.querySelectorAll('.patient-info-item');
                items.forEach(item => {
                    const text = item.textContent.trim();
                    const [key, value] = text.split(':').map(s => s.trim());
                    if (key && value) {
                        patientInfo[key.toLowerCase()] = value;
                    }
                });
            }

            const rows = table.querySelectorAll('tr');
            const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim().toLowerCase());

            const testNameIndex = headers.indexOf('test name/parameter');
            const resultIndex = headers.indexOf('result');
            const unitIndex = headers.indexOf('unit');
            const rangeIndex = headers.indexOf('reference range');
            const statusIndex = headers.indexOf('status');

            if (testNameIndex === -1 || resultIndex === -1 || statusIndex === -1) {
                console.warn('Required columns not found in results table');
                return { testResults, patientInfo };
            }

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].querySelectorAll('td');
                if (cells.length < headers.length) continue;

                const testName = cells[testNameIndex].textContent.trim();
                const result = parseFloat(cells[resultIndex].textContent.trim());
                const unit = unitIndex !== -1 ? cells[unitIndex].textContent.trim() : 'N/A';
                const referenceRange = rangeIndex !== -1 ? cells[rangeIndex].textContent.trim() : 'N/A';
                const status = cells[statusIndex].textContent.trim();

                if (isNaN(result)) continue;

                testResults.push({
                    testName,
                    result,
                    unit,
                    referenceRange,
                    status
                });
            }

            console.log('Parsed test results from analysisHTML:', testResults);
            console.log('Parsed patient info from analysisHTML:', patientInfo);
            return { testResults, patientInfo };
        }

        // Function to show no data message
        function showNoDataMessage() {
            document.getElementById('patientSummary').innerHTML = `
                <div class="parameter-card">
                    <h3>No Data Available</h3>
                    <p>No blood test data was found. Please upload a blood test report to receive personalized recommendations.</p>
                    <button id="uploadButton" style="background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-top: 15px;">Upload Blood Test</button>
                </div>
            `;

            document.getElementById('uploadButton').addEventListener('click', function () {
                window.location.href = 'upld.html';
            });
        }

        // Function to fetch recommendations from Gemini API
        async function getGeminiRecommendations(bloodData) {
            if (!bloodData || !bloodData.analysisHTML) {
                console.error('Invalid blood data provided to Gemini API: missing analysisHTML');
                return null;
            }

            const { testResults, patientInfo } = parseAnalysisHTML(bloodData.analysisHTML);
            const testDate = new Date(bloodData.date).toLocaleDateString();

            let testResultsText = testResults.map(result => {
                return `- ${result.testName}: ${result.result} ${result.unit} (${result.status}, Reference: ${result.referenceRange})`;
            }).join('\n');

            if (!testResultsText) {
                testResultsText = 'No test results available.';
            }

            const patientInfoText = Object.entries(patientInfo).map(([key, value]) => {
                return `${key}: ${value}`;
            }).join(', ');

            const apiKey = 'AIzaSyA5Mx9lkFnqkQR1oXYvRFAZsphAtsmtmgY'; // Replace with your actual Gemini API key
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`;

            const promptText = `Analyze the following blood test report and provide detailed diet, exercise, and meal plan recommendations based on all parameters. For the exercise section, include a comprehensive set of at least 5 exercises tailored to the specific health conditions indicated by the blood test results (e.g., low hemoglobin might suggest endurance exercises, high glucose might suggest cardio, high cholesterol might suggest fat-burning exercises, etc.), with accurate, detailed step-by-step instructions for each exercise to ensure proper execution. For the meal plan, provide a 3-day Kerala-style meal plan tailored to the specific blood test results, reflecting traditional South Indian cuisine from Kerala, incorporating local ingredients like coconut, rice, fish, and spices, and addressing the health conditions identified (e.g., low hemoglobin might include iron-rich fish, high glucose might avoid high-sugar items):

Patient Information:
${patientInfoText || 'Not provided'}

Test Results (including status and reference ranges):
${testResultsText}

Test Date: ${testDate}

Return the response as a JSON object (and ONLY the JSON object, with no additional text, Markdown, or code block formatting) in the following format:
{
    "diet": {
        "summary": "A brief summary of dietary recommendations based on the blood test results.",
        "recommendedFoods": [
            {"name": "Food 1", "description": "Why this is recommended based on specific parameters.", "icon": "üçé"},
            {"name": "Food 2", "description": "Why this is recommended based on specific parameters.", "icon": "ü•¶"}
        ],
        "foodsToLimit": [
            {"name": "Food 1", "description": "Why this should be limited based on specific parameters.", "icon": "üç©"},
            {"name": "Food 2", "description": "Why this should be limited based on specific parameters.", "icon": "üçü"}
        ],
        "nutritionGuidelines": [
            "Guideline 1 based on blood test analysis",
            "Guideline 2 based on blood test analysis"
        ]
    },
    "exercise": {
        "summary": "A brief summary of exercise recommendations tailored to the blood test results.",
        "exercises": [
            {
                "name": "Exercise 1",
                "description": "Why this is recommended based on specific parameters (e.g., improves hemoglobin).",
                "duration": "20 mins",
                "icon": "üèÉ‚Äç‚ôÇÔ∏è",
                "steps": [
                    "Step 1: Detailed instruction for proper execution.",
                    "Step 2: Detailed instruction for proper execution.",
                    "Step 3: Detailed instruction for proper execution."
                ]
            },
            {
                "name": "Exercise 2",
                "description": "Why this is recommended based on specific parameters (e.g., regulates glucose).",
                "duration": "30 mins",
                "icon": "üö¥‚Äç‚ôÄÔ∏è",
                "steps": [
                    "Step 1: Detailed instruction for proper execution.",
                    "Step 2: Detailed instruction for proper execution.",
                    "Step 3: Detailed instruction for proper execution."
                ]
            },
            {
                "name": "Exercise 3",
                "description": "Why this is recommended based on specific parameters (e.g., reduces cholesterol).",
                "duration": "25 mins",
                "icon": "üèãÔ∏è‚Äç‚ôÇÔ∏è",
                "steps": [
                    "Step 1: Detailed instruction for proper execution.",
                    "Step 2: Detailed instruction for proper execution.",
                    "Step 3: Detailed instruction for proper execution."
                ]
            },
            {
                "name": "Exercise 4",
                "description": "Why this is recommended based on specific parameters (e.g., improves circulation).",
                "duration": "15 mins",
                "icon": "üßò‚Äç‚ôÄÔ∏è",
                "steps": [
                    "Step 1: Detailed instruction for proper execution.",
                    "Step 2: Detailed instruction for proper execution.",
                    "Step 3: Detailed instruction for proper execution."
                ]
            },
            {
                "name": "Exercise 5",
                "description": "Why this is recommended based on specific parameters (e.g., boosts stamina).",
                "duration": "20 mins",
                "icon": "üèä‚Äç‚ôÇÔ∏è",
                "steps": [
                    "Step 1: Detailed instruction for proper execution.",
                    "Step 2: Detailed instruction for proper execution.",
                    "Step 3: Detailed instruction for proper execution."
                ]
            }
        ]
    },
    "mealPlan": [
        {
            "day": "Day 1",
            "meals": [
                {"name": "Breakfast", "description": "Kerala-style meal tailored to blood test results (e.g., Appam with vegetable stew for normal glucose)", "nutrition": "Nutritional info"},
                {"name": "Lunch", "description": "Kerala-style meal tailored to blood test results (e.g., Rice with fish curry for low hemoglobin)", "nutrition": "Nutritional info"},
                {"name": "Dinner", "description": "Kerala-style meal tailored to blood test results (e.g., Puttu with kadala curry)", "nutrition": "Nutritional info"}
            ]
        },
        {
            "day": "Day 2",
            "meals": [
                {"name": "Breakfast", "description": "Kerala-style meal tailored to blood test results", "nutrition": "Nutritional info"},
                {"name": "Lunch", "description": "Kerala-style meal tailored to blood test results", "nutrition": "Nutritional info"},
                {"name": "Dinner", "description": "Kerala-style meal tailored to blood test results", "nutrition": "Nutritional info"}
            ]
        },
        {
            "day": "Day 3",
            "meals": [
                {"name": "Breakfast", "description": "Kerala-style meal tailored to blood test results", "nutrition": "Nutritional info"},
                {"name": "Lunch", "description": "Kerala-style meal tailored to blood test results", "nutrition": "Nutritional info"},
                {"name": "Dinner", "description": "Kerala-style meal tailored to blood test results", "nutrition": "Nutritional info"}
            ]
        }
    ]
}`;

            console.log('Gemini API prompt:', promptText);

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    { text: promptText }
                                ]
                            }
                        ],
                        safetySettings: [
                            {
                                category: 'HARM_CATEGORY_HARASSMENT',
                                threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                            },
                            {
                                category: 'HARM_CATEGORY_HATE_SPEECH',
                                threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                            },
                            {
                                category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT',
                                threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                            },
                            {
                                category: 'HARM_CATEGORY_DANGEROUS_CONTENT',
                                threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Gemini API request failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                if (data.candidates && data.candidates.length > 0) {
                    let generatedText = data.candidates[0].content.parts[0].text;
                    console.log('Raw Gemini API response:', generatedText);

                    generatedText = generatedText.trim();
                    generatedText = generatedText.replace(/^```json\n|\n```$/g, '');
                    const jsonMatch = generatedText.match(/{[\s\S]*}/);
                    if (jsonMatch) {
                        generatedText = jsonMatch[0];
                    }

                    console.log('Cleaned Gemini API response:', generatedText);

                    try {
                        const recommendations = JSON.parse(generatedText);
                        console.log('Parsed Gemini API recommendations:', recommendations);
                        return {
                            diet: recommendations.diet || { summary: '', recommendedFoods: [], foodsToLimit: [], nutritionGuidelines: [] },
                            exercise: recommendations.exercise || { summary: '', exercises: [] },
                            mealPlan: recommendations.mealPlan || []
                        };
                    } catch (parseError) {
                        console.error('Failed to parse Gemini API response as JSON:', parseError);
                        return null;
                    }
                } else {
                    console.error('No candidates found in Gemini API response:', data);
                    return null;
                }
            } catch (error) {
                console.error('Error getting AI recommendations from Gemini API:', error);
                return null;
            }
        }

        // Main function to generate recommendations
        async function generateRecommendations(bloodData) {
            if (!bloodData || !bloodData.analysisHTML) {
                showNoDataMessage();
                return;
            }

            const { testResults, patientInfo } = parseAnalysisHTML(bloodData.analysisHTML);
            const date = new Date(bloodData.date).toLocaleDateString();

            const patientSummary = document.getElementById('patientSummary');
            patientSummary.innerHTML = `
                <h3 class="section-title">Health Profile</h3>
                <p>Recommendations based on your blood test from ${date}</p>
                <div class="parameter-card">
                    <h3>Patient Information</h3>
                    <p>${Object.entries(patientInfo).map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`).join('<br>') || 'Not provided'}</p>
                </div>
                <div id="loadingIndicator">
                    <p>Generating personalized AI recommendations... <span class="spinner"></span></p>
                </div>
                <div id="warningContainer"></div>
                <div id="abnormalParameters"></div>
            `;

            const abnormalParamsContainer = document.getElementById('abnormalParameters');
            const warningContainer = document.getElementById('warningContainer');

            // Check for critical values
            let criticalWarning = false;
            const criticalParams = [];

            testResults.forEach(result => {
                const testName = result.testName.toLowerCase();
                const value = result.result;
                const status = result.status.toLowerCase();
                const referenceRange = result.referenceRange.split('-').map(Number);

                // Define critical thresholds (these are illustrative; adjust based on medical standards)
                const isCritical = (testName.includes('hemoglobin') && (value < 7 || value > 18)) ||
                    (testName.includes('glucose') && (value < 50 || value > 200)) ||
                    (testName.includes('crp') && value > 10) ||
                    (testName.includes('cholesterol') && value > 240) ||
                    (testName.includes('ldl') && value > 160) ||
                    (testName.includes('hdl') && value < 30);

                if (isCritical) {
                    criticalWarning = true;
                    criticalParams.push(`${result.testName} (${value} ${result.unit})`);
                }

                let elem;
                if (testName.includes('hemoglobin') || testName.includes('hb')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card anemia`;
                        elem.innerHTML = `
                            <h3>Hemoglobin <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your hemoglobin level of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                } else if (testName.includes('glucose')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card diabetes`;
                        elem.innerHTML = `
                            <h3>Glucose <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your glucose level of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                } else if (testName.includes('crp')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card inflammation`;
                        elem.innerHTML = `
                            <h3>C-Reactive Protein <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your CRP level of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                } else if (testName.includes('rbc')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card anemia`;
                        elem.innerHTML = `
                            <h3>Red Blood Cell Count <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your RBC count of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                } else if (testName.includes('cholesterol')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card`;
                        elem.innerHTML = `
                            <h3>Cholesterol <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your cholesterol level of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                } else if (testName.includes('ldl')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card`;
                        elem.innerHTML = `
                            <h3>LDL Cholesterol <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your LDL level of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                } else if (testName.includes('hdl')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card`;
                        elem.innerHTML = `
                            <h3>HDL Cholesterol <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your HDL level of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                } else if (testName.includes('pcv') || testName.includes('hematocrit')) {
                    if (status !== 'normal') {
                        elem = document.createElement('div');
                        elem.className = `parameter-card`;
                        elem.innerHTML = `
                            <h3>PCV/Hematocrit <span class="parameter-status status-${status}">${status}</span></h3>
                            <p>Your PCV level of ${value} ${result.unit} is ${status} (${result.referenceRange}).</p>
                        `;
                        abnormalParamsContainer.appendChild(elem);
                    }
                }
            });

            if (abnormalParamsContainer.children.length === 0) {
                abnormalParamsContainer.innerHTML = `
                    <div class="parameter-card">
                        <h3>Overall Health <span class="parameter-status status-normal">Normal</span></h3>
                        <p>Your blood test results appear to be within normal ranges.</p>
                    </div>
                `;
            }

            if (criticalWarning) {
                warningContainer.innerHTML = `
                    <div class="warning-card">
                        <h3>‚ö†Ô∏è Critical Health Warning</h3>
                        <p>The following parameters are significantly outside normal ranges: ${criticalParams.join(', ')}. Please consult a doctor immediately for a professional medical evaluation, as these values may indicate a serious health condition requiring urgent attention.</p>
                    </div>
                `;
            }

            try {
                const aiRecommendations = await getGeminiRecommendations(bloodData);
                document.getElementById('loadingIndicator').style.display = 'none';

                if (aiRecommendations) {
                    generateDietRecommendations(aiRecommendations);
                    generateExerciseRecommendations(aiRecommendations);
                    generateMealPlan(aiRecommendations);
                } else {
                    throw new Error('No recommendations received from API');
                }
            } catch (error) {
                document.getElementById('loadingIndicator').style.display = 'none';
                patientSummary.innerHTML += `
                    <div class="parameter-card" style="border-left-color: #e74c3c;">
                        <h3>Error</h3>
                        <p>Unable to generate recommendations due to an API error. Please try again later.</p>
                    </div>
                `;
                console.error('Error with AI recommendations:', error);
            }
        }

        // Function to generate diet recommendations from API data
        function generateDietRecommendations(aiRecommendations) {
            const dietLoadingIndicator = document.getElementById('dietLoadingIndicator');
            const dietContent = document.getElementById('dietContent');
            const dietSummary = document.getElementById('dietSummary');
            const recommendedFoods = document.getElementById('recommendedFoods');
            const limitFoods = document.getElementById('limitFoods');
            const nutritionGuidelines = document.getElementById('nutritionGuidelines');

            if (!aiRecommendations || !aiRecommendations.diet) {
                dietContent.innerHTML = `
                    <div class="parameter-card" style="border-left-color: #e74c3c;">
                        <h3>Error</h3>
                        <p>Failed to load dietary recommendations from the API.</p>
                    </div>
                `;
                dietLoadingIndicator.style.display = 'none';
                dietContent.style.display = 'block';
                return;
            }

            dietSummary.innerHTML = `
                <div class="ai-recommendation">
                    <p>${aiRecommendations.diet.summary || 'No summary provided by AI.'}</p>
                    <span class="badge-ai">AI-Generated</span>
                </div>
            `;

            recommendedFoods.innerHTML = '';
            aiRecommendations.diet.recommendedFoods.forEach(food => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.innerHTML = `
                    <div class="food-icon">${food.icon || 'ü•ó'}</div>
                    <div class="food-title">${food.name}</div>
                    <div class="food-description">${food.description}</div>
                `;
                recommendedFoods.appendChild(foodItem);
            });

            limitFoods.innerHTML = '';
            aiRecommendations.diet.foodsToLimit.forEach(food => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.innerHTML = `
                    <div class="food-icon">${food.icon || '‚ö†Ô∏è'}</div>
                    <div class="food-title">${food.name}</div>
                    <div class="food-description">${food.description}</div>
                `;
                limitFoods.appendChild(foodItem);
            });

            nutritionGuidelines.innerHTML = '';
            aiRecommendations.diet.nutritionGuidelines.forEach(guideline => {
                const li = document.createElement('li');
                li.textContent = guideline;
                nutritionGuidelines.appendChild(li);
            });

            dietLoadingIndicator.style.display = 'none';
            dietContent.style.display = 'block';
        }

        // Function to generate exercise recommendations from API data with steps
        function generateExerciseRecommendations(aiRecommendations) {
            const exerciseSummary = document.getElementById('exerciseSummary');
            const exerciseRecommendations = document.getElementById('exerciseRecommendations');

            if (!aiRecommendations || !aiRecommendations.exercise) {
                exerciseSummary.innerHTML = `
                    <div class="parameter-card" style="border-left-color: #e74c3c;">
                        <h3>Error</h3>
                        <p>Failed to load exercise recommendations from the API.</p>
                    </div>
                `;
                return;
            }

            exerciseSummary.innerHTML = `
                <div class="ai-recommendation">
                    <p>${aiRecommendations.exercise.summary || 'No summary provided by AI.'}</p>
                    <span class="badge-ai">AI-Generated</span>
                </div>
            `;

            exerciseRecommendations.innerHTML = '';
            aiRecommendations.exercise.exercises.forEach(exercise => {
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                exerciseItem.innerHTML = `
                    <div class="exercise-item-icon">${exercise.icon || 'üèÉ‚Äç‚ôÇÔ∏è'}</div>
                    <div class="exercise-item-content">
                        <div class="exercise-title">${exercise.name}</div>
                        <div class="exercise-description">${exercise.description}</div>
                        <div class="exercise-duration">Duration: ${exercise.duration}</div>
                        <ol class="exercise-steps">
                            ${exercise.steps ? exercise.steps.map(step => `<li>${step}</li>`).join('') : '<li>No steps provided.</li>'}
                        </ol>
                    </div>
                `;
                exerciseRecommendations.appendChild(exerciseItem);
            });
        }

        // Function to generate Kerala-style meal plan from API data
        function generateMealPlan(aiRecommendations) {
            const mealPlanContainer = document.getElementById('mealPlanContainer');

            if (!aiRecommendations || !aiRecommendations.mealPlan || aiRecommendations.mealPlan.length === 0) {
                mealPlanContainer.innerHTML = `
                    <div class="parameter-card" style="border-left-color: #e74c3c;">
                        <h3>Error</h3>
                        <p>Failed to load Kerala-style meal plan from the API.</p>
                    </div>
                `;
                return;
            }

            mealPlanContainer.innerHTML = '';
            aiRecommendations.mealPlan.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'meal-plan-day';
                dayElement.innerHTML = `
                    <h4>${day.day} <span class="badge-ai">AI-Generated (Kerala Style)</span></h4>
                    ${day.meals.map(meal => `
                        <div class="meal-item">
                            <div class="meal-title">${meal.name}</div>
                            <div class="meal-description">${meal.description}</div>
                            <div class="meal-nutrition">Nutrition: ${meal.nutrition}</div>
                        </div>
                    `).join('')}
                `;
                mealPlanContainer.appendChild(dayElement);
            });
        }

        // Initialize on document load
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            document.getElementById('goBackButton').addEventListener('click', function () {
                window.location.href = 'upld.html';
            });

            document.getElementById('printButton').addEventListener('click', function () {
                window.print();
            });

            const latestReport = getLatestBloodReport();
            if (latestReport) {
                generateRecommendations(latestReport);
            } else {
                showNoDataMessage();
            }
        });
    </script>
</body>

</html>